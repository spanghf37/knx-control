var knx = require("knx");
var dpts = require("knx/src/dptlib"); // pour utilisation fonction "dpts.fromBuffer()" qui permet de convertir données buffer KNX dans les unités du DPT correspondant
//var module_mysql = require("module_mysql");
// var module_log = require("module_log");
var request = require('request'); // HTTP POST vers serveur EMONCMS
var ets = require("./ets"); // JSON export from ETS CSV export

 //knx_ga_groupname
 //knx_ga_address
 //knx_ga_central
 //knx_ga_unfiltered
 //knx_ga_description
 //knx_ga_datapointtype
 //knx_ga_security
 //knx_ga_id
 //knx_ga_value
 //knx_ga_dptsubtypeunit
 //knx_ga_timestamp
 //knx_ga_src

console.log("**** etsexport parse " + ets[0].knx_ga_groupname)
//console.log("**** etsexport parse " + etsexport[1].knx_ga_groupname)
//console.log("**** etsexport parse " + etsexport[2].knx_ga_groupname)

// var dpst; // conversion DPST (import CSV adresses de groupe ETS) vers DPT
var dpstTodpt = function(dpst) { //DPT-9-1 (issu du CSV export d'ETS) retourne DPT9.001 (utilisable en Node KNX)
    var dpt = "DPT" + dpst.charAt(5);
    for (i = 6; i < dpst.length; i+=1) {
        if (dpst.charAt(i) == "-" && dpst.length == (i + 2)) {
            dpt = dpt + ".00";
        }
        if (dpst.charAt(i) == "-" && dpst.length == (i + 3)) {
            dpt = dpt + ".0";
        }
        if (dpst.charAt(i) == "-" && dpst.length == (i + 4)) {
            dpt = dpt + ".";
        }
        if (dpst.charAt(i) != "-") {
            dpt = dpt + dpst.charAt(i);
        } //else {}
    }
    return dpt;
};

var knxgaTodpt = function(knxga, etsjson, callback) {
	var results = [];
 for (var i=0 ; i < etsjson.length ; i++)
 {
     if (etsjson[i].knx_ga_address == knxga) {
         results.push(etsjson[i]);
     }
 }
 console.log("***** result recherche " + results[0]);
}

knxgaTodpt("8/1/0",ets);
 
 //var sql = "SELECT * FROM knx_ga WHERE knx_ga_address = ?";
	//module_mysql.mysqlconnection.query(sql, [knxga], function(err, results) {
//		if (err) {
 //     module_log.writelog("*** knxgaTodpt : erreur *** ",err)
 //     console.log(new Date()," *** knxgaTodpt : erreur *** ",err);
//		}
//		if (results.length > 0) {
//			if (results[0].knx_ga_datapointtype.length > 0) {
//				dpst = results[0]; //results[0].knx_ga_datapointtype;
//				return callback(results[0]);
//			} else {
//				module_log.writelog("*** knxgaTodpt : erreur adresse de groupe connue mais DPT non renseigné")
//        console.log(new Date()," *** knxgaTodpt : erreur adresse de groupe connue mais DPT non renseigné");
//			}

	//	} else {
	//		module_log.writelog("*** Fonction knxgaTodpt : erreur adresse de groupe inconnue, mettre à jour table knx_ga de MySQL avec import ETS");
 //     console.log(new Date()," *** Fonction knxgaTodpt : erreur adresse de groupe inconnue, mettre à jour table knx_ga de MySQL avec import ETS");
	//	}
//	})
//}





 
var insert_emoncms = function(evt, src, dest, value) {
        console.log("***** début fonction request vers emoncms");
    var knx_ga_group = {
        ga: dest.toString(),
        name: "essai_name",
        dpst_ets: "testdpst",
        dpt_nodeknx: "testdpt",
        rawvalue:value.toString()
    };
        ////HTTP POST vers serveur EMONCMS

        var json = {};

        json[dest.toString().replace(/\//g, "-")] = knx_ga_group.rawvalue;
        //console.log("**** debug emoncms : " + result.knx_ga_groupname + JSON.stringify(json));
        //Set the headers
        var headers = {
            "content-type": "application/json"
        };

        //Configure the request
        console.log(process.env.EMONCMS_HOST);

        var sendemoncms = {
            url: encodeURI("http://" + process.env.EMONCMS_HOST + "/emoncms/input/post.json?node=1&fulljson=" + JSON.stringify(json) + "&apikey=" + process.env.EMONCMS_APIKEY),
            method: "GET",
            encoding: "utf8",
            headers: headers
        };

        var getinputemoncms = {
            url: "http://" + process.env.EMONCMS_HOST + "/emoncms/input/get_inputs.json" + "&apikey=" + process.env.EMONCMS_APIKEY,
            method: "GET",
            encoding: "utf8",
            headers: headers
        };
        console.log("***** milieu fonction request vers emoncms");
        request(sendemoncms, function(error, response, body) {
            console.log("***** fonction request vers emoncms");
            if (!error && response.statusCode === 200) {
                console.log(body);

                request(getinputemoncms, function(error, response, body) {
                    if (!error && response.statusCode === 200) {
                        var jsongetinput = JSON.parse(body);
                        //let json = JSON.parse(body);
                        var destknx = dest.toString().replace(/\//g, "-");

                        var idinput = JSON.stringify(jsongetinput[1][destknx].id); // id de l"input de EMONCMS correspondant à la key (qui est elle égale au GA KNX)

                        var checkdescriptionfield = {
                            url: "http://" + process.env.EMONCMS_HOST + "/emoncms/input/list.json" + "&apikey=" + process.env.EMONCMS_APIKEY,
                            method: "GET",
                            encoding: "utf8",
                            headers: headers
                        };

                        request(checkdescriptionfield, function(error, response, body) {
                            if (!error && response.statusCode === 200) {
                                var jsoncheckdescriptionfield = JSON.parse(body);
                                // let jsoncheckdescriptionfield = JSON.parse(body);
                                var descriptionfield = JSON.stringify(jsoncheckdescriptionfield);
                                var arraystring = descriptionfield.toString();
                                //var arraystringmod = arraystring.substr(1,arraystring.length - 2);

                                //console.log("*** debug arraystring ***" + arraystring);

                                //var arraystringmod = "[{"id":"162","nodeid":"1","name":"0-0-1","description":"LED Jardin Terrasse Est","processList":"","time":"1503934387","value":"0"},{"id":"164","nodeid":"1","name":"0-0-2","description":"LED Jardin Terrasse Nord","processList":"","time":"1503934393","value":"0"}]";

                                var testarray = JSON.parse(arraystring);

                                //console.log(" debug testarray length " + testarray.length);

                                var testarraylength = testarray.length;

                                for (i = 0; i < testarraylength; i+=1) {
                                    if (testarray[i].description === "") {
                                        //console.log(" debug checkdescriptionfield " + testarray[i].id);
                                        console.log(" description vide pour id " + testarray[i].id);

                                        //var idinputmod = idinput.substr(1,idinput.toString().length -2);
                                        //console.log("debug idinput " + idinputmod);

                                        destmod = dest.toString().replace(/\//g, "-");

                                        console.log("debug inputdescription knxmonitorcomment " + knx_ga_group.rawvalue);
                                        console.log("input id " + testarray[i].id);
                                        console.log("input name " + testarray[i].name);
                                        console.log("knx_ga_src " + destmod);
                                        //console.log("knx ga name " + result.knx_ga_groupname);

                                        if (destmod === testarray[i].name) {

                                            console.log(" ******* OK destmod et testarray name identiques ******");

                                            setdescriptionemoncms = {
                                                url: encodeURI('http://' + process.env.EMONCMS_HOST + '/emoncms/input/set.json?inputid=' + testarray[i].id + '&fields={"description":' + '"' + knx_ga_group.name + '"' + '}' + '&apikey=' + process.env.EMONCMS_APIKEY),
                                                method: "GET",
                                                encoding: "utf8",
                                                headers: headers
                                            };

                                            request(setdescriptionemoncms, function(error, response, body) {
                                                if (!error && response.statusCode === 200) {
                                                    //console.log("**** debug **** " + setdescriptionemoncms.url);
                                                    //console.log(body)
                                                } else {

                                                    console.log("error: " + error)
                                                    console.log("response.statusCode: " + response.statusCode)
                                                    console.log("response.statusText: " + response.statusText)
                                                }
                                            })

                                        }

                                    }
                                }

                            } else {

                                console.log("error: " + error)
                                console.log("response.statusCode: " + response.statusCode)
                                console.log("response.statusText: " + response.statusText)
                            }
                        })




                        //console.log("*** getinputemoncms : " + idinput);

                    } else {

                        console.log("error: " + error)
                        console.log("response.statusCode: " + response.statusCode)
                        console.log("response.statusText: " + response.statusText)
                    }
                })

            } else {

                console.log("error: " + error)
                console.log("response.statusCode: " + response.statusCode)
                console.log("response.statusText: " + response.statusText)
            }
        })

    //});
}

exports.dpstTodpt = dpstTodpt;
//exports.knxgaTodpt = knxgaTodpt;
exports.insert_emoncms = insert_emoncms;
