require('dotenv').config({path: './../.env'})
var request = require("request"); // HTTP POST vers serveur EMONCMS

var checkfeedid = 12 // EMONCMS feed id number to check last updated time 
    
//Set the headers
var headers = {
	"content-type": "application/json"
};
//Configure the request

var getinputemoncms = {
	url: "http://" + process.env.EMONCMS_HOST + "/emoncms/feed/timevalue.json?id=" + checkfeedid + "&apikey=" + process.env.EMONCMS_APIKEY,
	method: "GET",
	encoding: "utf8",
	headers: headers
};

request(getinputemoncms, function(error, response, body) {
	if (!error && response.statusCode === 200) {
		var jsongetinput = JSON.parse(body);
		var timelastinput = JSON.stringify(jsongetinput.time);
		var timediff = new Date()/1000 - timelastinput;
		console.log("timediff : " + timediff);
		if (timediff < 120) {
			console.log("HEALTHCHECK - ok");
			process.exit(0);
		}
		else {
			console.log("HEALTHCHECK - error, last update of EMONCMS > 120 seconds.");
			process.exit(1);
		}
	} else {
		console.log("HEALTHCHECK -error: " + error)
		process.exit(1);
	}
});
